name: Publish Envs

on:
  push:
    tags:
      - 'v*.*.*'
      - '!v*.*.*.dev*'  # Exclude dev releases
  workflow_dispatch:

jobs:
  detect-envs:
    name: Detect all environments
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_envs: ${{ steps.set-matrix.outputs.has_envs }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set matrix
        id: set-matrix
        run: |
          # Get all environment directories
          ENV_IDS=$(ls -d environments/*/ 2>/dev/null | xargs -n1 basename | jq -R . | jq -sc .)

          if [ "$ENV_IDS" = "[]" ] || [ "$ENV_IDS" = "null" ]; then
            echo "has_envs=false" >> $GITHUB_OUTPUT
            echo "matrix={\"env_id\":[]}" >> $GITHUB_OUTPUT
          else
            echo "Environments to publish: $ENV_IDS"
            echo "has_envs=true" >> $GITHUB_OUTPUT
            echo "matrix={\"env_id\":$ENV_IDS}" >> $GITHUB_OUTPUT
          fi

  publish-envs:
    name: Publish ${{ matrix.env_id }}
    needs: detect-envs
    if: needs.detect-envs.outputs.has_envs == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-envs.outputs.matrix) }}
    env:
      PRIME_API_KEY: ${{ secrets.PRIME_API_KEY }}
      PRIME_TEAM_ID: ${{ secrets.PRIME_TEAM_ID }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install prime
        run: uv tool install prime

      - name: Push environment
        env:
          ENV_ID: ${{ matrix.env_id }}
        run: |
          echo "Publishing $ENV_ID"
          set +e
          output=$(prime env push -p "environments/$ENV_ID" 2>&1)
          exit_code=$?
          echo "$output"
          set -e

          # Check if this is just an unchanged content hash (not a real failure)
          if echo "$output" | grep -qi "content hash.*already exists\|already exists with the same content"; then
            echo "⏭️  Environment $ENV_ID unchanged - skipping (content hash already exists)"
            exit 0
          elif [ $exit_code -eq 0 ]; then
            echo "✅ Successfully published $ENV_ID"
            exit 0
          else
            echo "❌ Failed to publish $ENV_ID"
            exit 1
          fi
